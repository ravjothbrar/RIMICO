<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artisan Todo | Personal Library</title>

  <!-- Book Emoji Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Framer Motion -->
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

  <!-- Marked.js for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            artisan: {
              purple: '#8B5CF6',
              purpleLight: '#A78BFA',
              purpleDark: '#7C3AED',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    html, body, #root {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
    }

    /* Liquid Background with Purple Theme */
    .liquid-bg {
      background: linear-gradient(135deg, #FAF8FF 0%, #F5F0FF 50%, #EDE5FF 100%);
      position: relative;
      overflow: hidden;
    }

    /* SVG Filter for Gooey/Liquid Effect */
    .goo-container {
      filter: url(#goo);
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* Animated Purple Blobs */
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(0px);
      opacity: 0.7;
    }

    .blob-1 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle at 30% 30%, #EDE9FE 0%, #DDD6FE 50%, #E5DEFF 100%);
      top: -5%;
      left: -5%;
      animation: float1 25s ease-in-out infinite;
    }

    .blob-2 {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle at 70% 30%, #F3F0FF 0%, #EDE9FE 50%, #DDD6FE 100%);
      top: 10%;
      right: -8%;
      animation: float2 30s ease-in-out infinite;
    }

    .blob-3 {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle at 50% 50%, #DDD6FE 0%, #E5DEFF 50%, #EDE9FE 100%);
      bottom: -10%;
      left: 15%;
      animation: float3 22s ease-in-out infinite;
    }

    .blob-4 {
      width: 250px;
      height: 250px;
      background: radial-gradient(circle at 40% 60%, #F3F0FF 0%, #EDE9FE 50%, #DDD6FE 100%);
      bottom: 20%;
      right: 10%;
      animation: float4 28s ease-in-out infinite;
    }

    .blob-5 {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle at 60% 40%, #EDE9FE 0%, #DDD6FE 60%, #E5DEFF 100%);
      top: 40%;
      left: 5%;
      animation: float5 20s ease-in-out infinite;
    }

    .blob-6 {
      width: 280px;
      height: 280px;
      background: radial-gradient(circle at 30% 70%, #DDD6FE 0%, #E5DEFF 50%, #EDE9FE 100%);
      top: 60%;
      right: -5%;
      animation: float6 26s ease-in-out infinite;
    }

    .blob-7 {
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at 50% 30%, #F3F0FF 0%, #EDE9FE 50%, #DDD6FE 100%);
      top: 5%;
      left: 40%;
      animation: float7 24s ease-in-out infinite;
    }

    @keyframes float1 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(80px, 60px) scale(1.1) rotate(10deg); }
      50% { transform: translate(40px, 120px) scale(0.95) rotate(-5deg); }
      75% { transform: translate(-40px, 80px) scale(1.05) rotate(5deg); }
    }

    @keyframes float2 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(-70px, 80px) scale(1.05) rotate(-8deg); }
      50% { transform: translate(-100px, 40px) scale(1.1) rotate(5deg); }
      75% { transform: translate(-50px, -40px) scale(0.95) rotate(-3deg); }
    }

    @keyframes float3 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(60px, -50px) scale(1.08) rotate(12deg); }
      50% { transform: translate(120px, -80px) scale(0.92) rotate(-8deg); }
      75% { transform: translate(40px, -30px) scale(1.04) rotate(4deg); }
    }

    @keyframes float4 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(-60px, -70px) scale(0.95) rotate(-10deg); }
      50% { transform: translate(-30px, 50px) scale(1.1) rotate(8deg); }
      75% { transform: translate(40px, -20px) scale(1.02) rotate(-5deg); }
    }

    @keyframes float5 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(50px, -60px) scale(1.12) rotate(15deg); }
      50% { transform: translate(80px, 30px) scale(0.9) rotate(-10deg); }
      75% { transform: translate(20px, 70px) scale(1.05) rotate(5deg); }
    }

    @keyframes float6 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(-80px, -50px) scale(1.06) rotate(-12deg); }
      50% { transform: translate(-40px, -100px) scale(0.94) rotate(6deg); }
      75% { transform: translate(30px, -60px) scale(1.08) rotate(-4deg); }
    }

    @keyframes float7 {
      0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
      25% { transform: translate(-40px, 80px) scale(0.92) rotate(8deg); }
      50% { transform: translate(60px, 60px) scale(1.15) rotate(-12deg); }
      75% { transform: translate(30px, -30px) scale(1.02) rotate(6deg); }
    }

    /* Purple Banner */
    .purple-banner {
      background: linear-gradient(90deg, #EDE9FE 0%, #DDD6FE 50%, #EDE9FE 100%);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
    }

    /* Mahogany Shelf */
    .shelf {
      background: linear-gradient(180deg, #8B7355 0%, #6B4423 30%, #4A2C2A 50%, #6B4423 70%, #8B7355 100%);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25), inset 0 1px 2px rgba(255,255,255,0.1);
    }

    /* 3D Book Spine */
    .book-spine {
      transform-style: preserve-3d;
      perspective: 800px;
    }

    .book-spine-inner {
      transform: rotateY(-4deg);
      box-shadow: 4px 4px 10px rgba(0,0,0,0.35), -2px 0 4px rgba(0,0,0,0.15), inset -4px 0 8px rgba(0,0,0,0.25), inset 2px 0 4px rgba(255,255,255,0.1);
      border-radius: 2px 4px 4px 2px;
    }

    /* Left edge shadow (binding) */
    .book-spine-inner::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      background: linear-gradient(90deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.05) 100%);
      border-radius: 2px 0 0 2px;
    }

    /* Top edge highlight (page edges visible from top) */
    .book-spine-inner::after {
      content: '';
      position: absolute;
      top: 0;
      left: 3px;
      right: 0;
      height: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.05) 60%, transparent 100%);
      border-radius: 0 4px 0 0;
    }

    /* Page Flicker Animation */
    @keyframes pageFlicker {
      0%, 100% { transform: scaleX(1); opacity: 1; }
      25% { transform: scaleX(0.96); opacity: 0.9; }
      50% { transform: scaleX(1.02); opacity: 1; }
      75% { transform: scaleX(0.98); opacity: 0.92; }
    }

    .page-flicker {
      animation: pageFlicker 0.5s ease-in-out;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(139, 92, 246, 0.1);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #8B5CF6;
      border-radius: 2px;
    }

    /* Modal Backdrop */
    .modal-backdrop {
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(4px);
    }

    /* Book Page Spread */
    .page-spread {
      background: linear-gradient(90deg, #FEFEFE 0%, #F8F8F8 49%, #E5E5E5 49%, #E5E5E5 51%, #F8F8F8 51%, #FEFEFE 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    /* Vertical Text */
    .vertical-text {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
    }

    /* Focus States */
    input:focus, button:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
    }

    /* Markdown Styles */
    .markdown-content strong { font-weight: 600; }
    .markdown-content em { font-style: italic; }
    .markdown-content p { margin-bottom: 0.5rem; }
    .markdown-content code {
      background: rgba(139, 92, 246, 0.1);
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
    }

    /* Attribution Button */
    .attribution-btn {
      border: 1.5px solid rgba(139, 92, 246, 0.25);
      transition: all 0.2s ease;
    }
    .attribution-btn:hover {
      border-color: #8B5CF6;
      background: rgba(139, 92, 246, 0.08);
    }

    /* Title Click Effect */
    .title-link {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .title-link:hover {
      transform: scale(1.02);
      text-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body>
  <!-- SVG Filter for Gooey Effect -->
  <svg style="position: absolute; width: 0; height: 0;">
    <defs>
      <filter id="goo">
        <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 25 -12" result="goo" />
        <feComposite in="SourceGraphic" in2="goo" operator="atop" />
      </filter>
    </defs>
  </svg>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const { motion, AnimatePresence } = Motion;

    const useLocalStorage = (key, initialValue) => {
      const [storedValue, setStoredValue] = useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          return initialValue;
        }
      });

      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {}
      };

      return [storedValue, setValue];
    };

    const DEFAULT_CATEGORIES = [
      { name: 'Personal', accent: '#8B5CF6' },
      { name: 'School', accent: '#1E40AF' },
      { name: 'Beri', accent: '#047857' },
      { name: 'AI', accent: '#0891B2' }
    ];

    const TIMEFRAME_WIDTHS = { 'quick': 45, 'short': 60, 'medium': 75, 'long': 95, 'extended': 115 };

    const Icons = {
      Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      Archive: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
      Book: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
      Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Calendar: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
      Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      Restore: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>,
      User: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      GitHub: () => <svg className="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>,
      Settings: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    };

    const MarkdownContent = ({ content }) => {
      if (!content) return <span className="text-gray-400 italic text-sm">No description provided.</span>;
      const html = marked.parse(content, { breaks: true });
      return <div className="markdown-content text-gray-700 leading-relaxed text-sm" dangerouslySetInnerHTML={{ __html: html }} />;
    };

    const MarkdownEditor = ({ value, onChange, rows, placeholder }) => {
      const textareaRef = useRef(null);

      const wrapSelection = useCallback((wrapper) => {
        const ta = textareaRef.current;
        if (!ta) return;
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        const text = ta.value;
        const selected = text.substring(start, end);

        if (selected.length > 0) {
          // Check if already wrapped - unwrap if so
          const before = text.substring(0, start);
          const after = text.substring(end);
          const wrapLen = wrapper.length;
          const alreadyWrapped = before.endsWith(wrapper) && after.startsWith(wrapper);
          if (alreadyWrapped) {
            const newText = before.slice(0, -wrapLen) + selected + after.slice(wrapLen);
            onChange(newText);
            setTimeout(() => { ta.selectionStart = start - wrapLen; ta.selectionEnd = end - wrapLen; }, 0);
          } else {
            const newText = before + wrapper + selected + wrapper + after;
            onChange(newText);
            setTimeout(() => { ta.selectionStart = start + wrapLen; ta.selectionEnd = end + wrapLen; }, 0);
          }
        } else {
          // No selection: insert wrapper pair and place cursor in middle
          const newText = text.substring(0, start) + wrapper + wrapper + text.substring(end);
          onChange(newText);
          setTimeout(() => { ta.selectionStart = ta.selectionEnd = start + wrapper.length; }, 0);
        }
      }, [onChange]);

      const handleKeyDown = useCallback((e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
          e.preventDefault();
          wrapSelection('**');
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
          e.preventDefault();
          wrapSelection('*');
        }
      }, [wrapSelection]);

      return (
        <div className="relative">
          <textarea
            ref={textareaRef}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            onKeyDown={handleKeyDown}
            rows={rows || 2}
            className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-800 placeholder-gray-400 resize-none"
            placeholder={placeholder || "**bold** (Ctrl+B), *italic* (Ctrl+I)"}
          />
          <div className="flex gap-1 mt-1">
            <button type="button" onClick={() => wrapSelection('**')} className="px-2 py-0.5 text-xs font-bold text-gray-500 bg-gray-100 rounded hover:bg-gray-200 transition-colors" title="Bold (Ctrl+B)">B</button>
            <button type="button" onClick={() => wrapSelection('*')} className="px-2 py-0.5 text-xs italic text-gray-500 bg-gray-100 rounded hover:bg-gray-200 transition-colors" title="Italic (Ctrl+I)">I</button>
          </div>
        </div>
      );
    };

    const AttributionLink = () => (
      <a href="https://ravjothbrar.com" target="_blank" rel="noopener noreferrer" className="attribution-btn inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/90 text-gray-600 text-xs font-medium">
        <Icons.User />Created by Ravjoth
      </a>
    );

    const AnimatedBlobs = () => (
      <div className="goo-container">
        <div className="blob blob-1" />
        <div className="blob blob-2" />
        <div className="blob blob-3" />
        <div className="blob blob-4" />
        <div className="blob blob-5" />
        <div className="blob blob-6" />
        <div className="blob blob-7" />
      </div>
    );

    const BookSpine = ({ task, onClick, onComplete, isFlickering, shelfColors }) => {
      const colors = shelfColors || { accent: '#8B5CF6' };
      const width = TIMEFRAME_WIDTHS[task.timeframe] || TIMEFRAME_WIDTHS['medium'];

      return (
        <motion.div
          className="book-spine relative cursor-pointer mx-0.5 flex-shrink-0"
          style={{ width: `${width}px`, height: '100%' }}
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, scale: 0.8, y: -20 }}
          whileHover={{ y: -12, scale: 1.05, rotateY: -6 }}
          transition={{ type: "spring", stiffness: 400, damping: 25 }}
          onClick={onClick}
        >
          <div className={`book-spine-inner h-full ${isFlickering ? 'page-flicker' : ''} relative overflow-hidden`} style={{ background: `linear-gradient(to bottom, ${colors.accent}CC, ${colors.accent}, ${colors.accent}DD)` }}>
            {/* Gold embossed lines at top and bottom */}
            <div className="absolute top-3 left-1 right-1 h-px bg-gradient-to-r from-transparent via-yellow-300/60 to-transparent" />
            <div className="absolute top-4 left-2 right-2 h-px bg-gradient-to-r from-transparent via-yellow-300/40 to-transparent" />
            <div className="absolute bottom-3 left-1 right-1 h-px bg-gradient-to-r from-transparent via-yellow-300/60 to-transparent" />
            <div className="absolute bottom-4 left-2 right-2 h-px bg-gradient-to-r from-transparent via-yellow-300/40 to-transparent" />
            {/* Title on spine */}
            <div className="vertical-text h-full flex items-center justify-center px-1" style={{ color: 'rgba(255,255,255,0.95)' }}>
              <span className="font-bold text-xs tracking-wider truncate drop-shadow-sm">{task.name}</span>
            </div>
            {/* Complete button */}
            <motion.button
              className="absolute bottom-1.5 left-1/2 -translate-x-1/2 w-5 h-5 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center"
              onClick={(e) => { e.stopPropagation(); onComplete(task.id); }}
              whileHover={{ scale: 1.15 }}
              whileTap={{ scale: 0.9 }}
            >
              <Icons.Check />
            </motion.button>
          </div>
        </motion.div>
      );
    };

    const ShelfQuadrant = ({ label, tasks, onBookClick, onComplete, flickeringId, shelfColors }) => {
      const colors = shelfColors || { accent: '#8B5CF6' };

      return (
        <div className="flex flex-col h-full">
          <div className="flex items-center gap-2 mb-1 px-2">
            <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: colors.accent }} />
            <h3 className="text-sm font-bold text-artisan-purple">{label}</h3>
            <span className="text-xs text-gray-400">{tasks.length}</span>
          </div>
          <div className="flex-1 relative">
            <div className="custom-scrollbar overflow-x-auto h-full">
              <div className="flex items-end h-[calc(100%-20px)] px-2 pt-2">
                <AnimatePresence mode="popLayout">
                  {tasks.length === 0 ? (
                    <div className="text-xs text-gray-400 italic px-2">Empty shelf...</div>
                  ) : (
                    tasks.map((task) => (
                      <BookSpine key={task.id} task={task} onClick={() => onBookClick(task)} onComplete={onComplete} isFlickering={flickeringId === task.id} shelfColors={colors} />
                    ))
                  )}
                </AnimatePresence>
              </div>
            </div>
            <div className="shelf absolute bottom-0 left-1 right-1 h-5 rounded-b-sm" />
          </div>
        </div>
      );
    };

    const PageSpreadModal = ({ task, onClose, onComplete, onDelete, categories }) => {
      const cat = (categories || []).find(c => c.name === task.label);
      const shelfColor = cat || { accent: '#8B5CF6' };
      const formatDate = (ds) => ds ? new Date(ds).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'No due date';

      return (
        <motion.div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose}>
          <motion.div className="page-spread relative w-full max-w-lg rounded-xl overflow-hidden" initial={{ scale: 0.9, rotateY: -45 }} animate={{ scale: 1, rotateY: 0 }} exit={{ scale: 0.9, rotateY: 45 }} transition={{ type: "spring", stiffness: 250, damping: 25 }} onClick={(e) => e.stopPropagation()}>
            <button onClick={onClose} className="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center z-10"><Icons.X /></button>
            <div className="p-6">
              <div className="flex items-start gap-3 mb-4">
                <div className="w-1.5 h-16 rounded-full" style={{ backgroundColor: shelfColor.accent }} />
                <div className="flex-1">
                  <span className="text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded-full" style={{ backgroundColor: `${shelfColor.accent}15`, color: shelfColor.accent }}>{task.label}</span>
                  <h2 className="text-xl font-bold text-gray-800 mt-2">{task.name}</h2>
                  <div className="flex items-center gap-1.5 text-gray-500 text-xs mt-1"><Icons.Calendar /><span>{formatDate(task.dueDate)}</span></div>
                </div>
              </div>
              <div className="border-t border-gray-200 my-4" />
              <div className="mb-4">
                <h4 className="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-2">Description</h4>
                <MarkdownContent content={task.description} />
              </div>
              <div className="mb-5">
                <h4 className="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-2">Timeframe</h4>
                <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700 capitalize">{task.timeframe}</span>
              </div>
              <div className="flex gap-2">
                <motion.button className="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 bg-artisan-purple text-white rounded-lg text-sm font-semibold hover:bg-artisan-purpleDark" whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} onClick={() => { onComplete(task.id); onClose(); }}><Icons.Check />Complete</motion.button>
                <motion.button className="flex items-center justify-center px-4 py-2.5 bg-red-50 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-100" whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} onClick={() => { onDelete(task.id); onClose(); }}><Icons.Trash /></motion.button>
              </div>
            </div>
          </motion.div>
        </motion.div>
      );
    };

    const AddTaskModal = ({ onClose, onAdd, categories }) => {
      const [formData, setFormData] = useState({ name: '', label: categories[0]?.name || '', description: '', dueDate: '', timeframe: 'medium' });
      const handleSubmit = (e) => { e.preventDefault(); if (formData.name.trim()) { onAdd({ ...formData, id: Date.now().toString(), completed: false, createdAt: new Date().toISOString() }); onClose(); } };

      return (
        <motion.div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose}>
          <motion.div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-xl" initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.9, y: 20 }} onClick={(e) => e.stopPropagation()}>
            <div className="p-5">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold text-gray-800">Add Book</h2>
                <button onClick={onClose} className="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><Icons.X /></button>
              </div>
              <form onSubmit={handleSubmit} className="space-y-3">
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">Title *</label>
                  <input type="text" required value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-800 placeholder-gray-400" placeholder="Task name" />
                </div>
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">Shelf</label>
                  <div className="flex flex-wrap gap-1">
                    {categories.map((cat) => (
                      <button key={cat.name} type="button" onClick={() => setFormData({ ...formData, label: cat.name })} className={`px-2 py-1.5 rounded-lg text-xs font-medium transition-all ${formData.label === cat.name ? 'ring-2 ring-artisan-purple bg-purple-50 text-artisan-purple' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'}`}>
                        <span className="inline-block w-2 h-2 rounded-full mr-1" style={{ backgroundColor: cat.accent }} />{cat.name}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-semibold text-gray-600 mb-1">Description <span className="font-normal text-gray-400">(markdown)</span></label>
                  <MarkdownEditor value={formData.description} onChange={(val) => setFormData({ ...formData, description: val })} rows={2} />
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">Due Date</label>
                    <input type="date" value={formData.dueDate} onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })} className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-800" />
                  </div>
                  <div>
                    <label className="block text-xs font-semibold text-gray-600 mb-1">Timeframe</label>
                    <select value={formData.timeframe} onChange={(e) => setFormData({ ...formData, timeframe: e.target.value })} className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-800">
                      <option value="quick">Quick</option><option value="short">Short</option><option value="medium">Medium</option><option value="long">Long</option><option value="extended">Extended</option>
                    </select>
                  </div>
                </div>
                <motion.button type="submit" className="w-full px-4 py-2.5 bg-artisan-purple text-white rounded-lg text-sm font-semibold hover:bg-artisan-purpleDark" whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>Add to Library</motion.button>
              </form>
            </div>
          </motion.div>
        </motion.div>
      );
    };

    const CategoryManagerModal = ({ onClose, categories, onSave }) => {
      const [cats, setCats] = useState(categories.map(c => ({ ...c })));
      const [newName, setNewName] = useState('');
      const [newColor, setNewColor] = useState('#8B5CF6');

      const addCategory = () => {
        const trimmed = newName.trim();
        if (trimmed && !cats.find(c => c.name === trimmed)) {
          setCats([...cats, { name: trimmed, accent: newColor }]);
          setNewName('');
          setNewColor('#8B5CF6');
        }
      };

      const removeCategory = (name) => {
        if (cats.length <= 1) return;
        setCats(cats.filter(c => c.name !== name));
      };

      const updateColor = (name, color) => {
        setCats(cats.map(c => c.name === name ? { ...c, accent: color } : c));
      };

      const handleSave = () => {
        onSave(cats);
        onClose();
      };

      return (
        <motion.div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} onClick={onClose}>
          <motion.div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-xl" initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.9, y: 20 }} onClick={(e) => e.stopPropagation()}>
            <div className="p-5">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-bold text-gray-800">Manage Shelves</h2>
                <button onClick={onClose} className="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500"><Icons.X /></button>
              </div>
              <div className="space-y-2 mb-4 max-h-48 overflow-y-auto">
                {cats.map((cat) => (
                  <div key={cat.name} className="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
                    <input type="color" value={cat.accent} onChange={(e) => updateColor(cat.name, e.target.value)} className="w-7 h-7 rounded cursor-pointer border-0 p-0" />
                    <span className="flex-1 text-sm font-medium text-gray-700">{cat.name}</span>
                    <button onClick={() => removeCategory(cat.name)} className="p-1 rounded text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors" disabled={cats.length <= 1} title={cats.length <= 1 ? 'Must have at least one category' : 'Remove'}>
                      <Icons.Trash />
                    </button>
                  </div>
                ))}
              </div>
              <div className="flex gap-2 mb-4">
                <input type="color" value={newColor} onChange={(e) => setNewColor(e.target.value)} className="w-9 h-9 rounded cursor-pointer border-0 p-0 flex-shrink-0" />
                <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); addCategory(); } }} className="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-800 placeholder-gray-400" placeholder="New category name" />
                <button onClick={addCategory} className="px-3 py-2 bg-artisan-purple text-white rounded-lg text-sm font-semibold hover:bg-artisan-purpleDark flex-shrink-0">Add</button>
              </div>
              <motion.button onClick={handleSave} className="w-full px-4 py-2.5 bg-artisan-purple text-white rounded-lg text-sm font-semibold hover:bg-artisan-purpleDark" whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>Save Changes</motion.button>
            </div>
          </motion.div>
        </motion.div>
      );
    };

    const ArchiveView = ({ tasks, onRestore, onDelete, categories }) => {
      const formatDate = (ds) => new Date(ds).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const getCatColor = (label) => {
        const cat = categories.find(c => c.name === label);
        return cat ? cat.accent : '#8B5CF6';
      };
      return (
        <div className="h-full overflow-auto p-4">
          <h2 className="text-lg font-bold text-artisan-purple mb-3">Archived</h2>
          {tasks.length === 0 ? (
            <div className="text-center py-8 text-gray-400 text-sm">No archived books</div>
          ) : (
            <div className="space-y-2">
              {tasks.map((task) => (
                <div key={task.id} className="bg-white/90 rounded-lg p-3 flex items-center gap-3 shadow-sm">
                  <div className="w-1.5 h-10 rounded-full" style={{ backgroundColor: getCatColor(task.label) }} />
                  <div className="flex-1 min-w-0">
                    <h4 className="font-medium text-sm text-gray-800 truncate">{task.name}</h4>
                    <p className="text-xs text-gray-500">{formatDate(task.completedAt)}</p>
                  </div>
                  <button onClick={() => onRestore(task.id)} className="p-1.5 rounded bg-purple-50 text-artisan-purple hover:bg-purple-100"><Icons.Restore /></button>
                  <button onClick={() => onDelete(task.id)} className="p-1.5 rounded bg-red-50 text-red-500 hover:bg-red-100"><Icons.Trash /></button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    /* Small floating blobs for header */
    const HeaderMiniBlobs = () => {
      const blobCount = 6;
      const blobs = React.useMemo(() => {
        return Array.from({ length: blobCount }, (_, i) => ({
          id: i,
          size: 8 + Math.random() * 14,
          x: Math.random() * 100,
          y: Math.random() * 100,
          duration: 4 + Math.random() * 6,
          delay: Math.random() * -10,
          dx1: (Math.random() - 0.5) * 60,
          dy1: (Math.random() - 0.5) * 30,
          dx2: (Math.random() - 0.5) * 60,
          dy2: (Math.random() - 0.5) * 30,
          dx3: (Math.random() - 0.5) * 60,
          dy3: (Math.random() - 0.5) * 30,
        }));
      }, []);

      return (
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
          {blobs.map((b) => (
            <motion.div
              key={b.id}
              className="absolute rounded-full"
              style={{
                width: b.size,
                height: b.size,
                left: `${b.x}%`,
                top: `${b.y}%`,
                background: 'radial-gradient(circle, rgba(139,92,246,0.35) 0%, rgba(221,214,254,0.2) 100%)',
              }}
              animate={{
                x: [0, b.dx1, b.dx2, b.dx3, 0],
                y: [0, b.dy1, b.dy2, b.dy3, 0],
              }}
              transition={{
                duration: b.duration,
                repeat: Infinity,
                ease: "easeInOut",
                delay: b.delay,
              }}
            />
          ))}
        </div>
      );
    };

    const App = () => {
      const [tasks, setTasks] = useLocalStorage('artisan-todo-tasks', []);
      const [categories, setCategories] = useLocalStorage('artisan-todo-categories', DEFAULT_CATEGORIES);
      const [activeView, setActiveView] = useState('library');
      const [showAddModal, setShowAddModal] = useState(false);
      const [showCategoryManager, setShowCategoryManager] = useState(false);
      const [selectedTask, setSelectedTask] = useState(null);
      const [flickeringId, setFlickeringId] = useState(null);

      const catMap = React.useMemo(() => {
        const m = {};
        categories.forEach(c => { m[c.name] = c; });
        return m;
      }, [categories]);

      const activeTasks = tasks.filter(t => !t.completed);
      const archivedTasks = tasks.filter(t => t.completed);

      const sortByDueDate = (tasks) => [...tasks].sort((a, b) => {
        if (!a.dueDate && !b.dueDate) return 0;
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      });

      const tasksByLabel = categories.reduce((acc, cat) => {
        acc[cat.name] = sortByDueDate(activeTasks.filter(t => t.label === cat.name));
        return acc;
      }, {});

      const handleComplete = (taskId) => {
        setFlickeringId(taskId);
        setTimeout(() => {
          setTasks(tasks.map(t => t.id === taskId ? { ...t, completed: true, completedAt: new Date().toISOString() } : t));
          setFlickeringId(null);
        }, 500);
      };

      const handleRestore = (taskId) => setTasks(tasks.map(t => t.id === taskId ? { ...t, completed: false, completedAt: null } : t));
      const handleDelete = (taskId) => setTasks(tasks.filter(t => t.id !== taskId));
      const handleAddTask = (newTask) => setTasks([...tasks, newTask]);
      const goToLibrary = () => setActiveView('library');

      // Determine grid layout based on number of categories
      const catCount = categories.length;
      const cols = catCount === 1 ? 1 : 2;
      const rows = Math.ceil(catCount / cols);
      const needsScroll = rows > 2;

      const gridStyle = needsScroll
        ? { display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '0.75rem', gridAutoRows: 'minmax(200px, 1fr)' }
        : { display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gridTemplateRows: `repeat(${rows}, 1fr)`, gap: '0.75rem', height: '100%' };

      return (
        <div className="liquid-bg h-screen flex flex-col">
          {/* Animated Lilac Blobs */}
          <AnimatedBlobs />

          {/* Purple Banner Header */}
          <header className="purple-banner relative z-10 px-4 py-3">
            <HeaderMiniBlobs />
            <div className="flex items-center justify-between relative z-10">
              <AttributionLink />
              <h1
                onClick={goToLibrary}
                className="title-link text-2xl font-extrabold text-artisan-purple"
              >
                Artisan Todo
              </h1>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowCategoryManager(true)} className="w-8 h-8 rounded-full bg-white/90 text-gray-500 hover:text-artisan-purple flex items-center justify-center shadow-sm transition-colors" title="Manage Shelves">
                  <Icons.Settings />
                </button>
                <div className="bg-white/90 rounded-full p-0.5 flex shadow-sm">
                  <button onClick={() => setActiveView('library')} className={`px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1 transition-all ${activeView === 'library' ? 'bg-artisan-purple text-white' : 'text-gray-500 hover:text-gray-700'}`}><Icons.Book />Library</button>
                  <button onClick={() => setActiveView('archive')} className={`px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1 transition-all ${activeView === 'archive' ? 'bg-artisan-purple text-white' : 'text-gray-500 hover:text-gray-700'}`}><Icons.Archive />{archivedTasks.length}</button>
                </div>
                <motion.button onClick={() => setShowAddModal(true)} className="w-9 h-9 rounded-full bg-artisan-purple text-white flex items-center justify-center shadow-lg shadow-purple-300/50" whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }}><Icons.Plus /></motion.button>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className="relative z-10 flex-1 px-4 pb-2 overflow-hidden">
            <AnimatePresence mode="wait">
              {activeView === 'library' ? (
                <motion.div key="library" className={needsScroll ? 'h-full overflow-y-auto custom-scrollbar' : 'h-full'} initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                  <div style={gridStyle}>
                    {categories.map((cat) => (
                      <div key={cat.name} className="bg-white/50 backdrop-blur-sm rounded-xl p-2 overflow-hidden border border-white/60" style={needsScroll ? { minHeight: '200px' } : {}}>
                        <ShelfQuadrant label={cat.name} tasks={tasksByLabel[cat.name] || []} onBookClick={setSelectedTask} onComplete={handleComplete} flickeringId={flickeringId} shelfColors={cat} />
                      </div>
                    ))}
                  </div>
                </motion.div>
              ) : (
                <motion.div key="archive" className="h-full bg-white/50 backdrop-blur-sm rounded-xl overflow-hidden border border-white/60" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                  <ArchiveView tasks={archivedTasks} onRestore={handleRestore} onDelete={handleDelete} categories={categories} />
                </motion.div>
              )}
            </AnimatePresence>
          </main>

          {/* Modals */}
          <AnimatePresence>
            {showAddModal && <AddTaskModal onClose={() => setShowAddModal(false)} onAdd={handleAddTask} categories={categories} />}
            {selectedTask && <PageSpreadModal task={selectedTask} onClose={() => setSelectedTask(null)} onComplete={handleComplete} onDelete={handleDelete} categories={categories} />}
            {showCategoryManager && <CategoryManagerModal onClose={() => setShowCategoryManager(false)} categories={categories} onSave={setCategories} />}
          </AnimatePresence>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
